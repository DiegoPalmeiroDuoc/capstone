{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Intexta</title>
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
    <div class="logo-container">
        <img src="{% static 'img/logo.png' %}" alt="Logo Intexta" class="logo-img">
        <div>
            <div class="logo-text">Intexta</div>
            <div class="subtitle">Tu asistente virtual</div>
        </div>
    </div>
    <nav>
        <a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <button onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>
    </nav>
</header>

<section class="dashboard-section">
    <h2><i class="fas fa-user-circle"></i> Mi Perfil</h2>
    
    <!-- Informaci√≥n del usuario -->
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <h3><i class="fas fa-info-circle"></i> Informaci√≥n Personal</h3>
        
        <div class="form-group">
            <label><i class="fas fa-envelope"></i> Email</label>
            <input type="text" id="userEmail" readonly style="background: var(--bg-color); cursor: not-allowed;">
        </div>
        
        <div class="form-group">
            <label><i class="fas fa-id-card"></i> ID de Usuario</label>
            <input type="text" id="userId" readonly style="background: var(--bg-color); cursor: not-allowed; font-family: monospace; font-size: 0.9rem;">
        </div>
    </div>
    
    <!-- WhatsApp Configuration -->
    <div class="card" style="max-width: 600px; margin: 2rem auto;">
        <h3><i class="fab fa-whatsapp"></i> Configuraci√≥n de WhatsApp</h3>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Vincula tu n√∫mero de WhatsApp para recibir notificaciones y consultar tus documentos desde el chatbot.
        </p>
        
        <div class="form-group">
            <label for="telefono">
                <i class="fas fa-phone"></i> N√∫mero de WhatsApp
            </label>
            <div style="display: flex; gap: 0.5rem;">
                <select id="countryCode" style="max-width: 100px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;">
                    <option value="+56">üá®üá± +56</option>
                    <option value="+1">üá∫üá∏ +1</option>
                    <option value="+54">üá¶üá∑ +54</option>
                    <option value="+55">üáßüá∑ +55</option>
                    <option value="+57">üá®üá¥ +57</option>
                    <option value="+52">üá≤üáΩ +52</option>
                    <option value="+51">üáµüá™ +51</option>
                    <option value="+34">üá™üá∏ +34</option>
                </select>
                <input 
                    type="tel" 
                    id="telefono" 
                    placeholder="912345678"
                    pattern="[0-9]{9,15}"
                    style="flex: 1;"
                >
            </div>
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                Formato: Solo n√∫meros, sin espacios ni guiones
            </small>
        </div>
        
        <button onclick="updatePhone()" class="primary">
            <i class="fas fa-save"></i> Guardar N√∫mero
        </button>
        
        <div id="phoneStatus" style="margin-top: 1rem;"></div>
    </div>
    
    <!-- Instrucciones WhatsApp -->
    <div class="card" style="max-width: 600px; margin: 2rem auto; background: linear-gradient(135deg, #25D366, #128C7E); color: white; box-shadow: 0 8px 20px rgba(37, 211, 102, 0.3);">
        <h3 style="color: white; margin-bottom: 1.5rem;"><i class="fas fa-question-circle"></i> ¬øC√≥mo usar el chatbot?</h3>
        
        <!-- Instrucciones paso a paso -->
        <ol style="padding-left: 1.5rem; line-height: 2; margin-bottom: 2rem; font-size: 1rem;">
            <li>Guarda tu n√∫mero de WhatsApp arriba ‚òùÔ∏è</li>
            <li>Agrega este n√∫mero a tus contactos: <strong>+1 415 523 8886</strong></li>
            <li>Env√≠a el mensaje: <code style="background: rgba(0,0,0,0.2); padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.95rem;">join fence-wolf</code></li>
            <li>¬°Listo! Ahora puedes consultar tus documentos por WhatsApp üéâ</li>
        </ol>

        <!-- Secci√≥n centrada: QR + Bot√≥n -->
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; margin: 2rem 0;">
            <!-- C√≥digo QR -->
            <div style="background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <img src="{% static 'img/qr-wsp.png' %}" alt="QR WhatsApp" style="width: 200px; height: 200px; display: block;">
            </div>
            
            <!-- Bot√≥n WhatsApp -->
            <button 
                onclick="window.open('https://wa.me/14155238886?text=join%20fence-wolf', '_blank')" 
                style="
                    background: #128C7E; 
                    color: white; 
                    border: none; 
                    padding: 1rem 2rem; 
                    font-size: 1.1rem; 
                    font-weight: 600; 
                    border-radius: 50px; 
                    cursor: pointer; 
                    display: flex; 
                    align-items: center; 
                    gap: 0.75rem;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;
                    min-width: 250px;
                    justify-content: center;
                "
                onmouseover="this.style.background='#0d6d61'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                onmouseout="this.style.background='#128C7E'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'"
            >
                <i class="fab fa-whatsapp" style="font-size: 1.5rem;"></i>
                <span>Abrir WhatsApp</span>
            </button>
            
            <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">
                Escanea el QR o haz clic en el bot√≥n para comenzar
            </p>
        </div>

        <!-- Ejemplos de uso -->
        <div style="background: rgba(0,0,0,0.2); padding: 1.25rem; border-radius: 12px; margin-top: 1.5rem; border-left: 4px solid rgba(255,255,255,0.5);">
            <strong style="font-size: 1.05rem; display: block; margin-bottom: 0.75rem;">
                <i class="fas fa-lightbulb"></i> Ejemplos de preguntas:
            </strong>
            <ul style="list-style: none; padding-left: 0; margin: 0; line-height: 2;">
                <li>üí¨ "Mu√©strame mis documentos"</li>
                <li>üí¨ "¬øCu√°ntos archivos tengo?"</li>
                <li>üí¨ "Busca informaci√≥n sobre contratos"</li>
                <li>üí¨ "¬øQu√© dice mi √∫ltimo documento?"</li>
                <li>üí¨ "/ayuda - Ver todos los comandos"</li>
            </ul>
        </div>
    </div>
</section>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgqUuI5uJDvmXTyzt9NdtR6BquSqk2OqQ",
        authDomain: "admin-doc-ia.firebaseapp.com",
        projectId: "admin-doc-ia",
        storageBucket: "admin-doc-ia.appspot.com",
        messagingSenderId: "711945554973",
        appId: "1:711945554973:web:64892a3f8614cdbf088af4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);


    let currentUser = null;

    // Verificar autenticaci√≥n
    console.log("üîç perfil.html - Verificando autenticaci√≥n...");
    
    // DEBUG: Guardar logs en localStorage para ver el flujo
    const addLog = (msg) => {
        const logs = JSON.parse(localStorage.getItem('authLogs') || '[]');
        logs.push(`[${new Date().toLocaleTimeString()}] PERFIL: ${msg}`);
        if (logs.length > 20) logs.shift();
        localStorage.setItem('authLogs', JSON.stringify(logs));
        console.log(msg);
    };
    
    addLog("üîç P√°gina cargada, verificando autenticaci√≥n...");
    
    // Mostrar indicador de carga
    document.body.style.opacity = '0.5';
    
    let hasInitialized = false;
    let authCheckTimeout = null;
    let callCount = 0;
    
    // SOLUCI√ìN: Dar m√°s tiempo a Firebase para cargar el estado
    // Si despu√©s de 2000ms no hay usuario, entonces s√≠ redirigir
    const checkAuthWithTimeout = (user) => {
        callCount++;
        addLog(`üìû onAuthStateChanged llamada #${callCount}, usuario: ${user ? user.email : 'null'}`);
        
        if (hasInitialized) {
            addLog("‚ö†Ô∏è Ya inicializado, ignorando llamada adicional");
            return;
        }
        
        if (user) {
            // Si hay usuario, inicializar inmediatamente
            hasInitialized = true;
            if (authCheckTimeout) {
                clearTimeout(authCheckTimeout);
                addLog("‚úÖ Usuario encontrado, cancelando timeout");
            }
            addLog(`‚úÖ Usuario autenticado: ${user.email}, inicializando perfil...`);
            initializeProfile(user);
        } else {
            // Si no hay usuario, esperar un poco por si est√° cargando
            if (!authCheckTimeout) {
                addLog("‚è≥ No hay usuario a√∫n, esperando 2000ms por si Firebase est√° cargando...");
                authCheckTimeout = setTimeout(() => {
                    if (!hasInitialized) {
                        hasInitialized = true;
                        addLog(`‚ùå Timeout despu√©s de ${callCount} llamadas - No hay usuario, redirigiendo a /login`);
                        window.location.href = '/login';
                    }
                }, 2000); // Aumentado a 2 segundos
            } else {
                addLog(`‚è≥ Esperando... (llamada #${callCount})`);
            }
        }
    };
    
    onAuthStateChanged(auth, checkAuthWithTimeout);
    
    // Funci√≥n para inicializar el perfil
    async function initializeProfile(user) {
        console.log("üìù Inicializando perfil para:", user.email);
        document.body.style.opacity = '1';
        
        currentUser = user;
        document.getElementById('userEmail').value = user.email;
        document.getElementById('userId').value = user.uid;
        
        // Cargar n√∫mero de tel√©fono guardado
        await loadUserPhone(user.uid);
    }

    // Cargar n√∫mero de tel√©fono guardado
    async function loadUserPhone(uid) {
        try {
            const userDoc = await getDoc(doc(db, 'usuarios', uid));
            
            if (userDoc.exists()) {
                const data = userDoc.data();
                if (data.telefono) {
                    // Separar c√≥digo de pa√≠s y n√∫mero
                    const phone = data.telefono;
                    const match = phone.match(/^(\+\d{1,3})(\d+)$/);
                    
                    if (match) {
                        document.getElementById('countryCode').value = match[1];
                        document.getElementById('telefono').value = match[2];
                    } else {
                        document.getElementById('telefono').value = phone;
                    }
                    
                    document.getElementById('phoneStatus').innerHTML = `
                        <div style="padding: 1rem; background: var(--success-color); color: white; border-radius: 8px;">
                            <i class="fas fa-check-circle"></i> N√∫mero verificado: ${data.telefono}
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error("Error cargando tel√©fono:", error);
        }
    }

    // Actualizar n√∫mero de tel√©fono
    window.updatePhone = async function() {
        const countryCode = document.getElementById('countryCode').value;
        const telefono = document.getElementById('telefono').value.trim();
        
        if (!telefono) {
            showToast("Por favor ingresa tu n√∫mero de WhatsApp", "warning");
            return;
        }
        
        // Validar formato
        if (!/^\d{9,15}$/.test(telefono)) {
            showToast("N√∫mero inv√°lido. Solo usa d√≠gitos sin espacios", "error");
            return;
        }
        
        const fullPhone = countryCode + telefono;
        
        try {
            // Guardar en Firestore
            await setDoc(doc(db, 'usuarios', currentUser.uid), {
                uid: currentUser.uid,
                email: currentUser.email,
                telefono: fullPhone,
                fechaActualizacion: serverTimestamp()
            }, { merge: true });
            
            showToast("‚úÖ N√∫mero de WhatsApp guardado correctamente", "success");
            
            document.getElementById('phoneStatus').innerHTML = `
                <div style="padding: 1rem; background: var(--success-color); color: white; border-radius: 8px;">
                    <i class="fas fa-check-circle"></i> N√∫mero verificado: ${fullPhone}
                    <br><small>Ahora puedes usar el chatbot de WhatsApp</small>
                </div>
            `;
            
        } catch (error) {
            console.error("Error guardando tel√©fono:", error);
            showToast("Error al guardar el n√∫mero: " + error.message, "error");
        }
    };

    // Cerrar sesi√≥n
    window.logoutUser = async function() {
        try {
            await signOut(auth);
            window.location.href = '/login?logout=true';
        } catch (error) {
            console.error("Error al cerrar sesi√≥n:", error);
        }
    };

    // Toast notifications
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="fas ${icons[type]}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 300);
        }, 3000);
    }
</script>

</body>
</html>
