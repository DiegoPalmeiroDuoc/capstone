{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Intexta</title>
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="{% static 'img/logo.png' %}" alt="Logo Intexta" class="logo-img">
            <div>
                <div class="logo-text">Intexta</div>
                <div class="subtitle">Tu asistente virtual</div>
            </div>
        </div>
        <nav>
            <button onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
        </nav>
    </header>

    <section class="dashboard-section">
        <h2>Bienvenido <span id="userEmail"></span> a tu Dashboard</h2>
        <p>Aquí puedes administrar los documentos que usará tu asistente virtual.</p>

        <!-- Subida de archivos -->
        <div class="upload-form">
            <input type="file" id="fileInput">
            <input type="text" id="descripcion" placeholder="Descripción del documento">
            <button onclick="uploadFile()">Subir documento</button>
        </div>

        <!-- Lista de archivos -->
        <h3>Mis documentos</h3>
        <ul id="fileList"></ul>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Configuración Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBgqUuI5uJDvmXTyzt9NdtR6BquSqk2OqQ",
            authDomain: "admin-doc-ia.firebaseapp.com",
            projectId: "admin-doc-ia",
            storageBucket: "admin-doc-ia.firebasestorage.app",
            messagingSenderId: "711945554973",
            appId: "1:711945554973:web:64892a3f8614cdbf088af4"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);

        // Proteger la vista y mostrar email solo si está verificado
        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "/login";
            } else {
                user.reload().then(() => {
                    if (!user.emailVerified) {
                        alert("Debes verificar tu correo antes de continuar");
                        signOut(auth);
                        window.location.href = "/login";
                    } else {
                        document.getElementById('userEmail').innerText = user.email;
                        loadFiles();
                    }
                });
            }
        });

        // Cerrar sesión
        window.logoutUser = function () {
            signOut(auth).then(() => {
                window.location.href = "/";
            });
        };

        // Subir archivo
        window.uploadFile = async function () {
            const file = document.getElementById('fileInput').files[0];
            const descripcion = document.getElementById('descripcion').value;

            if (!file) {
                alert("Selecciona un archivo");
                return;
            }

            const uid = auth.currentUser.uid;
            const fileRef = ref(storage, `clientes/${uid}/${file.name}`);

            try {
                await uploadBytes(fileRef, file);
                const url = await getDownloadURL(fileRef);
                await addDoc(collection(db, "documentos"), {
                    nombre: file.name,
                    url: url,
                    tipo: file.type,
                    fechaSubida: new Date().toISOString(),
                    usuarioId: uid, // clave para reglas
                    descripcion: descripcion
                });
                alert("Archivo subido exitosamente");
                loadFiles();
            } catch (error) {
                console.error("Error al subir archivo:", error);
                alert("Error: " + error.message);
            }
        };

        // Cargar archivos
        async function loadFiles() {
            const uid = auth.currentUser.uid;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = "";

            try {
                const q = query(collection(db, "documentos"), where("usuarioId", "==", uid));
                const snapshot = await getDocs(q);

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const li = document.createElement("li");
                    li.innerHTML = `
                    ${data.nombre} - <a href="${data.url}" target="_blank">Ver</a> 
                    <button onclick="deleteFile('${docSnap.id}', '${data.nombre}')"><i class="fas fa-trash"></i> Eliminar</button>
                `;
                    fileList.appendChild(li);
                });
            } catch (error) {
                console.error("Error al cargar archivos:", error);
                alert("Error: " + error.message);
            }
        }

        // Eliminar archivo
        window.deleteFile = async function (docId, fileName) {
            const uid = auth.currentUser.uid;
            const fileRef = ref(storage, `clientes/${uid}/${fileName}`);

            try {
                await deleteObject(fileRef);
                await deleteDoc(doc(db, "documentos", docId));
                loadFiles();
            } catch (error) {
                console.error("Error al eliminar archivo:", error);
                alert("Error: " + error.message);
            }
        };
    </script>

</body>

</html>