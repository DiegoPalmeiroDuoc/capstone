{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Intexta</title>
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <header>
        <div class="logo-container">
            <img src="{% static 'img/logo.png' %}" alt="Logo Intexta" class="logo-img">
            <div>
                <div class="logo-text">Intexta</div>
                <div class="subtitle">Tu asistente virtual</div>
            </div>
        </div>
        <nav>
            <a href="/perfil" style="text-decoration: none; color: inherit; margin-right: 1rem;">
                <i class="fas fa-user-circle"></i> Mi Perfil
            </a>
            <button onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>
        </nav>
    </header>

    <section class="dashboard-section">
        <h2>Bienvenido a tu Dashboard</h2>
        <p class="text-center" style="color: var(--text-light);">
            <i class="fas fa-user-circle"></i> <span id="userEmail" style="font-weight: 600;"></span>
        </p>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-file-alt"></i>
                <div class="number" id="totalDocs">0</div>
                <div class="label">Total documentos</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-check-circle"></i>
                <div class="number" id="processedDocs">0</div>
                <div class="label">Procesados</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-clock"></i>
                <div class="number" id="pendingDocs">0</div>
                <div class="label">Pendientes</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="number" id="errorDocs">0</div>
                <div class="label">Con errores</div>
            </div>
        </div>

        <!-- Subida de archivos mejorada -->
        <div class="upload-form">
            <h3><i class="fas fa-cloud-upload-alt"></i> Subir nuevo documento</h3>
            <div class="form-group">
                <label for="fileInput">
                    <i class="fas fa-file"></i> Seleccionar archivo
                </label>
                <div style="position: relative;">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.pptx,.txt">
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        Formatos aceptados: PDF, Word, Excel, PowerPoint, TXT
                    </small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="descripcion">
                    <i class="fas fa-edit"></i> Descripci√≥n (opcional)
                </label>
                <textarea 
                    id="descripcion" 
                    placeholder="Describe brevemente el contenido del documento..."
                    rows="3"
                ></textarea>
            </div>
            
            <button onclick="uploadFile()" class="success">
                <i class="fas fa-upload"></i> Subir documento
            </button>
            
            <div id="uploadProgress" class="hidden" style="margin-top: 1rem;">
                <div style="background: var(--border-color); border-radius: var(--radius-full); height: 8px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <small id="progressText" style="display: block; margin-top: 0.5rem; text-align: center; color: var(--text-light);"></small>
            </div>
        </div>

        <!-- Filtros -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <button onclick="filterDocs('all')" id="filterAll" class="secondary">
                <i class="fas fa-list"></i> Todos
            </button>
            <button onclick="filterDocs('procesado')" id="filterProcessed" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-check"></i> Procesados
            </button>
            <button onclick="filterDocs('pendiente')" id="filterPending" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-clock"></i> Pendientes
            </button>
            <button onclick="filterDocs('error')" id="filterError" class="danger">
                <i class="fas fa-times"></i> Errores
            </button>
        </div>

        <!-- Lista de archivos mejorada -->
        <h3><i class="fas fa-folder-open"></i> Mis documentos</h3>
        <ul id="fileList">
            <li style="text-align: center; padding: 2rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-light);">Cargando documentos...</p>
            </li>
        </ul>
    </section>

    <div id="toastContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBgqUuI5uJDvmXTyzt9NdtR6BquSqk2OqQ",
            authDomain: "admin-doc-ia.firebaseapp.com",
            projectId: "admin-doc-ia",
            storageBucket: "admin-doc-ia.firebasestorage.app",
            messagingSenderId: "711945554973",
            appId: "1:711945554973:web:64892a3f8614cdbf088af4"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);

        let allDocuments = [];
        let currentFilter = 'all';

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // DEBUG: Sistema de logs persistentes
        const addLog = (msg) => {
            const logs = JSON.parse(localStorage.getItem('authLogs') || '[]');
            logs.push(`[${new Date().toLocaleTimeString()}] DASHBOARD: ${msg}`);
            if (logs.length > 20) logs.shift();
            localStorage.setItem('authLogs', JSON.stringify(logs));
            console.log(msg);
        };

        // Proteger la vista - verificar autenticaci√≥n
        addLog("üîç P√°gina cargada, verificando autenticaci√≥n...");
        
        onAuthStateChanged(auth, async (user) => {
            addLog(`‚úÖ Estado de autenticaci√≥n recibido: ${user ? user.email : 'null'}`);
            
            if (!user) {
                addLog("‚ùå No hay usuario, redirigiendo a /login");
                window.location.href = "/login";
                return;
            }
            
            try {
                // Recargar datos del usuario
                await user.reload();
                
                if (!user.emailVerified) {
                    addLog("‚ö†Ô∏è Email no verificado, cerrando sesi√≥n");
                    showToast("Debes verificar tu correo antes de continuar", "error");
                    await signOut(auth);
                    setTimeout(() => window.location.href = "/login", 2000);
                    return;
                }
                
                addLog(`‚úÖ Usuario autenticado y verificado: ${user.email}`);
                // Usuario autenticado y verificado
                document.getElementById('userEmail').innerText = user.email;
                loadFiles();
                
            } catch (error) {
                addLog(`‚ùå Error verificando usuario: ${error.message}`);
                console.error("Error verificando usuario:", error);
                await signOut(auth);
                window.location.href = "/login";
            }
        });

        // Cerrar sesi√≥n
        window.logoutUser = function () {
            signOut(auth).then(() => {
                showToast("Sesi√≥n cerrada exitosamente", "success");
                setTimeout(() => window.location.href = "/login?logout=true", 1000);
            });
        };

        // Subir archivo con progreso
        window.uploadFile = async function () {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const descripcion = document.getElementById('descripcion').value;

            if (!file) {
                showToast("Por favor selecciona un archivo", "warning");
                return;
            }

            const allowedTypes = [
                'application/pdf',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'text/plain'
            ];

            if (!allowedTypes.includes(file.type)) {
                showToast("Tipo de archivo no soportado", "error");
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB
                showToast("El archivo no debe superar 10MB", "error");
                return;
            }

            const uid = auth.currentUser.uid;
            const fileRef = ref(storage, `clientes/${uid}/${Date.now()}_${file.name}`);

            // Mostrar progreso
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.innerText = 'Preparando subida...';

            try {
                // Simular progreso (Firebase no proporciona progreso real con uploadBytes)
                progressBar.style.width = '30%';
                progressText.innerText = 'Subiendo archivo...';
                
                await uploadBytes(fileRef, file);
                
                progressBar.style.width = '70%';
                progressText.innerText = 'Generando URL...';
                
                const url = await getDownloadURL(fileRef);
                
                progressBar.style.width = '90%';
                progressText.innerText = 'Registrando en base de datos...';
                
                await addDoc(collection(db, "documentos"), {
                    nombre: file.name,
                    url: url,
                    tipo: file.type,
                    tama√±o: file.size,
                    fechaSubida: new Date().toISOString(),
                    usuarioId: uid,
                    descripcion: descripcion || 'Sin descripci√≥n',
                    estado: 'pendiente'
                });
                
                progressBar.style.width = '100%';
                progressText.innerText = '¬°Completado!';
                
                showToast("Archivo subido exitosamente. Se procesar√° autom√°ticamente.", "success");
                
                fileInput.value = '';
                document.getElementById('descripcion').value = '';
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    loadFiles();
                }, 1500);
                
            } catch (error) {
                console.error("Error al subir archivo:", error);
                showToast("Error al subir archivo: " + error.message, "error");
                progressDiv.classList.add('hidden');
            }
        };

        // Cargar archivos con estad√≠sticas
        async function loadFiles() {
            const uid = auth.currentUser.uid;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<li style="text-align: center; padding: 2rem;"><div class="spinner"></div><p style="margin-top: 1rem;">Cargando...</p></li>';

            try {
                // Consulta simple sin orderBy (no requiere √≠ndice)
                const q = query(
                    collection(db, "documentos"), 
                    where("usuarioId", "==", uid)
                );
                const snapshot = await getDocs(q);

                allDocuments = [];
                snapshot.forEach(docSnap => {
                    allDocuments.push({
                        id: docSnap.id,
                        ...docSnap.data()
                    });
                });

                // Ordenar en el cliente por fecha (descendente)
                allDocuments.sort((a, b) => {
                    const dateA = new Date(a.fechaSubida);
                    const dateB = new Date(b.fechaSubida);
                    return dateB - dateA; // M√°s reciente primero
                });

                // Actualizar estad√≠sticas
                updateStats();
                
                // Mostrar documentos
                displayDocuments();
                
            } catch (error) {
                console.error("Error al cargar archivos:", error);
                fileList.innerHTML = '<li style="text-align: center; color: var(--error-color);"><i class="fas fa-exclamation-circle"></i> Error al cargar documentos</li>';
                showToast("Error al cargar documentos", "error");
            }
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const total = allDocuments.length;
            const procesados = allDocuments.filter(doc => doc.estado === 'procesado').length;
            const pendientes = allDocuments.filter(doc => doc.estado === 'pendiente').length;
            const errores = allDocuments.filter(doc => doc.estado === 'error').length;

            document.getElementById('totalDocs').innerText = total;
            document.getElementById('processedDocs').innerText = procesados;
            document.getElementById('pendingDocs').innerText = pendientes;
            document.getElementById('errorDocs').innerText = errores;
        }

        // Mostrar documentos con filtro
        function displayDocuments() {
            const fileList = document.getElementById('fileList');
            
            let filtered = allDocuments;
            if (currentFilter !== 'all') {
                filtered = allDocuments.filter(doc => doc.estado === currentFilter);
            }

            if (filtered.length === 0) {
                fileList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--text-light);"><i class="fas fa-inbox"></i><p>No hay documentos para mostrar</p></li>';
                return;
            }

            fileList.innerHTML = '';
            
            filtered.forEach(docData => {
                const estado = docData.estado || 'pendiente';
                
                const estadoConfig = {
                    'pendiente': {
                        icon: 'fa-clock',
                        color: '#f59e0b',
                        label: 'Pendiente',
                        class: 'status-pendiente'
                    },
                    'procesando': {
                        icon: 'fa-spinner fa-spin',
                        color: '#3b82f6',
                        label: 'Procesando',
                        class: 'status-procesando'
                    },
                    'procesado': {
                        icon: 'fa-check-circle',
                        color: '#10b981',
                        label: 'Procesado',
                        class: 'status-procesado'
                    },
                    'error': {
                        icon: 'fa-exclamation-circle',
                        color: '#ef4444',
                        label: 'Error',
                        class: 'status-error'
                    }
                };
                
                const config = estadoConfig[estado] || estadoConfig['pendiente'];
                const caracteres = docData.caracteresTotales ? ` ‚Ä¢ ${docData.caracteresTotales.toLocaleString()} caracteres` : '';
                const tama√±o = docData.tama√±o ? ` ‚Ä¢ ${(docData.tama√±o / 1024).toFixed(1)} KB` : '';
                const fecha = new Date(docData.fechaSubida).toLocaleDateString('es-ES');
                
                const li = document.createElement("li");
                li.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <div class="file-info">
                        <strong>${docData.nombre}</strong>
                        <small>
                            <span class="status-badge ${config.class}">
                                <i class="fas ${config.icon}"></i> ${config.label}
                            </span>
                            ${caracteres}${tama√±o}
                        </small>
                        <small style="display: block; margin-top: 0.25rem;">
                            ${docData.descripcion} ‚Ä¢ ${fecha}
                        </small>
                    </div>
                    <div class="file-actions">
                        <a href="${docData.url}" target="_blank" style="text-decoration: none;">
                            <button class="secondary"><i class="fas fa-download"></i> Descargar</button>
                        </a>
                        <button class="danger" onclick="deleteFile('${docData.id}', '${docData.nombre}')">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
                fileList.appendChild(li);
            });
        }

        // Filtrar documentos
        window.filterDocs = function(filter) {
            currentFilter = filter;
            
            // Actualizar estilos de botones
            ['filterAll', 'filterProcessed', 'filterPending', 'filterError'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.style.opacity = '0.6';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            const activeBtn = {
                'all': 'filterAll',
                'procesado': 'filterProcessed',
                'pendiente': 'filterPending',
                'error': 'filterError'
            }[filter];
            
            if (activeBtn) {
                const btn = document.getElementById(activeBtn);
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1.05)';
            }
            
            displayDocuments();
        };

        // Eliminar archivo
        window.deleteFile = async function (docId, fileName) {
            if (!confirm(`¬øEst√°s seguro de eliminar "${fileName}"?`)) {
                return;
            }

            const uid = auth.currentUser.uid;
            
            try {
                // Encontrar el documento para obtener el nombre real del archivo en Storage
                const docData = allDocuments.find(d => d.id === docId);
                if (docData && docData.url) {
                    // Extraer el path del Storage desde la URL
                    const urlParts = docData.url.split('/');
                    const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                    const filePath = decodeURIComponent(encodedPath);
                    const fileRef = ref(storage, filePath);
                    
                    try {
                        await deleteObject(fileRef);
                    } catch (storageError) {
                        console.warn("Archivo no encontrado en Storage:", storageError);
                    }
                }
                
                await deleteDoc(doc(db, "documentos", docId));
                showToast("Documento eliminado exitosamente", "success");
                loadFiles();
            } catch (error) {
                console.error("Error al eliminar archivo:", error);
                showToast("Error al eliminar: " + error.message, "error");
            }
        };

        // Auto-refresh cada 30 segundos para ver cambios de estado
        setInterval(() => {
            loadFiles();
        }, 30000);
    </script>

</body>

</html>